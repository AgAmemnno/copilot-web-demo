<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マージンコントロール付きテキストボックス・コンポーネントテスター</title>
    <style>
        /* Google Fonts の読み込み */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,slnt,wdth,wght@8..144,-10..0,25..151,100..1000&display=swap');

        :root {
            --root-font-size: 16px; /* ルートフォントサイズの初期値 */
            --fractal-scale-base: 1; /* rem単位でのフラクタルスケールの基準 (1rem = ルートフォントサイズ) */
            --fractal-scale-ratio: 1.25; /* フラクタルスケールの比率 (例: Major Third) */
        }

        body {
            font-family: 'Inter', sans-serif;
            font-size: var(--root-font-size); /* ルートフォントサイズを適用 */
            background-color: #f0f4f8; /* Light grayish blue */
            color: #2d3748; /* Dark gray */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .control-panel {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            width: 100%;
            max-width: 600px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-panel h2 {
            grid-column: 1 / -1; /* Span all columns */
            font-size: 1.5em;
            font-weight: 700;
            color: #2c5282; /* Darker blue */
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #e2e8f0; /* Light gray border */
            padding-bottom: 10px;
        }
        
        .control-group {
            background-color: #f7fafc; /* Very light gray */
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568; /* Medium gray */
            font-size: 0.9em;
        }

        .control-group input[type="number"],
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0; /* Light gray border */
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            margin-top: 4px;
        }
         .control-group input[type="range"] {
            width: 100%;
        }


        .component-display-area {
            width: 100%;
            max-width: 800px; /* Display area can be wider */
            padding: 20px;
            background-color: #e2e8f0; /* Slightly darker background for contrast */
            border-radius: 8px;
            border: 1px solid #cbd5e0;
            display: flex; /* To center the component if it's smaller */
            justify-content: center;
            align-items: flex-start; /* Align to top if multiple components */
            min-height: 300px; /* Ensure some space for the component */
        }

        /* Web ComponentのスタイルはShadow DOM内で定義 */
    </style>
</head>
<body>

    <div class="control-panel">
        <h2>グローバル設定 &amp; コンポーネント制御</h2>
        <div class="control-group">
            <label for="rootFontSize">ルートフォントサイズ (px):</label>
            <input type="number" id="rootFontSize" value="16" min="8">
        </div>
        <div class="control-group">
            <label for="scaleRatio">フラクタルスケール比率:</label>
            <select id="scaleRatio">
                <option value="1.2">1.200 (Minor Third)</option>
                <option value="1.25" selected>1.250 (Major Third)</option>
                <option value="1.333">1.333 (Perfect Fourth)</option>
                <option value="1.414">1.414 (Augmented Fourth)</option>
                <option value="1.5">1.500 (Perfect Fifth)</option>
                <option value="1.618">1.618 (Golden Ratio)</option>
            </select>
        </div>
        <div class="control-group">
            <label for="componentFontSizeStep">コンポーネント フォントサイズ (スケールステップ):</label>
            <input type="number" id="componentFontSizeStep" value="0" step="1" min="-5" max="10">
            <p style="font-size: 0.8em; color: #718096;">現在の値: <span id="componentFontSizeRemDisplay">1.000</span>rem</p>
        </div>
         <div class="control-group">
            <label for="componentText">コンポーネント内テキスト:</label>
            <textarea id="componentText" rows="3">これはマージンとフォントサイズを調整できるテキストボックスです。複数行にも対応しています。</textarea>
        </div>

        <h3 style="grid-column: 1 / -1; margin-top: 20px; font-size: 1.2em; color: #2c5282;">外枠マージン (rem単位)</h3>
        <div class="control-group">
            <label for="marginTop">Margin Top (rem):</label>
            <input type="number" id="marginTop" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label for="marginRight">Margin Right (rem):</label>
            <input type="number" id="marginRight" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label for="marginBottom">Margin Bottom (rem):</label>
            <input type="number" id="marginBottom" value="1" step="0.1">
        </div>
        <div class="control-group">
            <label for="marginLeft">Margin Left (rem):</label>
            <input type="number" id="marginLeft" value="1" step="0.1">
        </div>
    </div>

    <div class="component-display-area">
        <margin-text-box id="myTextBox">
            これは初期テキストです。
        </margin-text-box>
    </div>

    <script>
        class MarginTextBox extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this._fontSizeRem = 1; // Default font size in rem, relative to :host
                this._marginTopRem = 0;
                this._marginRightRem = 0;
                this._marginBottomRem = 0;
                this._marginLeftRem = 0;
                this._textContent = this.textContent || "サンプルテキスト";
            }

            static get observedAttributes() {
                return ['font-size-rem', 'margin-top-rem', 'margin-right-rem', 'margin-bottom-rem', 'margin-left-rem', 'text-content'];
            }

            attributeChangedCallback(name, oldValue, newValue) {
                switch (name) {
                    case 'font-size-rem':
                        this._fontSizeRem = parseFloat(newValue) || 1;
                        break;
                    case 'margin-top-rem':
                        this._marginTopRem = parseFloat(newValue) || 0;
                        break;
                    case 'margin-right-rem':
                        this._marginRightRem = parseFloat(newValue) || 0;
                        break;
                    case 'margin-bottom-rem':
                        this._marginBottomRem = parseFloat(newValue) || 0;
                        break;
                    case 'margin-left-rem':
                        this._marginLeftRem = parseFloat(newValue) || 0;
                        break;
                    case 'text-content':
                        this._textContent = newValue || "";
                        break;
                }
                this._render();
            }

            connectedCallback() {
                // Initial text content from light DOM if no attribute is set
                if (!this.hasAttribute('text-content') && this.textContent.trim().length > 0) {
                    this._textContent = this.textContent.trim();
                }
                this._render();
            }

            _render() {
                this.shadowRoot.innerHTML = `
                    <style>
                        :host {
                            display: block; /* Component itself is a block */
                            font-size: ${this._fontSizeRem}rem; /* Font size relative to root font size */
                            margin-top: ${this._marginTopRem}rem;
                            margin-right: ${this._marginRightRem}rem;
                            margin-bottom: ${this._marginBottomRem}rem;
                            margin-left: ${this._marginLeftRem}rem;
                            border: 2px solid #4299e1; /* Blue border for visibility */
                            padding: 0.8em; /* Padding relative to this component's font-size */
                            background-color: #ebf8ff; /* Light blue background */
                            width: fit-content; /* Adjust to content width by default */
                            max-width: 100%; /* Ensure it doesn't overflow its container */
                            box-sizing: border-box;
                        }
                        .content {
                            /* line-height, etc. can be styled here based on this component's font-size */
                            line-height: 1.5; /* Example line height using relative unit */
                        }
                        /* Example of using slot if needed for more complex content later */
                        /* slot {} */ 
                    </style>
                    <div class="content">
                        ${this._textContent.replace(/\n/g, '<br>')}
                    </div>
                `;
            }
        }
        customElements.define('margin-text-box', MarginTextBox);

        // --- Control Panel Logic ---
        const rootFontSizeInputElement = document.getElementById('rootFontSize');
        const scaleRatioElement = document.getElementById('scaleRatio');
        const componentFontSizeStepElement = document.getElementById('componentFontSizeStep');
        const componentFontSizeRemDisplayElement = document.getElementById('componentFontSizeRemDisplay');
        const componentTextElement = document.getElementById('componentText');
        const marginTopElement = document.getElementById('marginTop');
        const marginRightElement = document.getElementById('marginRight');
        const marginBottomElement = document.getElementById('marginBottom');
        const marginLeftElement = document.getElementById('marginLeft');
        const myTextBoxElement = document.getElementById('myTextBox');

        function updateComponent() {
            if (!myTextBoxElement) return;

            // Update root font size
            const newRootFontSize = parseFloat(rootFontSizeInputElement.value);
            if (!isNaN(newRootFontSize) && newRootFontSize > 0) {
                document.documentElement.style.setProperty('--base-font-size', `${newRootFontSize}px`);
                document.documentElement.style.fontSize = `var(--base-font-size)`; // Apply to html
            }
            
            // Calculate component font size based on fractal scale
            const baseForScale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--base-font-size')); // Use the CSS variable as base
            const ratio = parseFloat(scaleRatioElement.value);
            const step = parseInt(componentFontSizeStepElement.value, 10);
            const componentFontSizeRem = Math.pow(ratio, step) * (parseFloat(getComputedStyle(document.documentElement).fontSize) / baseForScale); // Calculate rem based on current root
            // The above calculation for componentFontSizeRem needs to be simpler:
            // It should be base_scale_rem * ratio^step.
            // Let's assume the fractal scale base is 1rem (i.e., root font size).
            const fractalBaseRem = 1; // The base of our scale is 1rem (the root font size)
            const finalComponentFontSizeRem = fractalBaseRem * Math.pow(ratio, step);


            myTextBoxElement.setAttribute('font-size-rem', finalComponentFontSizeRem.toFixed(3));
            componentFontSizeRemDisplayElement.textContent = finalComponentFontSizeRem.toFixed(3);
            
            myTextBoxElement.setAttribute('margin-top-rem', marginTopElement.value);
            myTextBoxElement.setAttribute('margin-right-rem', marginRightElement.value);
            myTextBoxElement.setAttribute('margin-bottom-rem', marginBottomElement.value);
            myTextBoxElement.setAttribute('margin-left-rem', marginLeftElement.value);
            myTextBoxElement.setAttribute('text-content', componentTextElement.value);
        }

        [rootFontSizeInputElement, scaleRatioElement, componentFontSizeStepElement, componentTextElement, 
         marginTopElement, marginRightElement, marginBottomElement, marginLeftElement].forEach(el => {
            el.addEventListener('input', updateComponent);
        });

        // Initial update
        updateComponent();

    </script>
</body>
</html>
