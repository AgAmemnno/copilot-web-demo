<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Worker Canvas背景とコンテンツ (カラーマネジメント対応)</title>
    <style>
        body {
            margin: 0;
            background-color: #f0f0f0; /* 背景色 */
            display: flex;
            flex-direction: column; /* 要素を縦に並べる */
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            font-family: sans-serif;
        }
        /* メインキャンバスを非表示 */
        #tilingCanvas {
            display: none;
        }
        /* 背景とコンテンツを表示するDIV */
        #backgroundDiv {
            width: 80%;
            max-width: 700px;
            height: 400px;
            border: 1px solid #aaa;
            position: relative; /* コンテンツ配置の基準 */
            overflow: hidden; /* はみ出し防止 */
            background-color: #eee; /* デフォルト背景色 */
            background-size: cover; /* 背景画像をカバー */
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease-in-out; /* 背景変更を少し速く */
            padding: 20px; /* コンテンツ用余白 */
            box-sizing: border-box;
            color: #333;
            margin-top: 10px; /* セレクターとの間に余白 */
        }
         #backgroundDiv h2 {
             margin-top: 0;
         }
         #backgroundDiv p {
             background-color: rgba(255, 255, 255, 0.7); /* テキスト背景を少し白く */
             padding: 5px;
             border-radius: 3px;
             display: inline-block; /* 背景をテキスト幅に合わせる */
         }
         /* セレクター用スタイル */
         .controls {
             margin-bottom: 20px;
             padding: 10px;
             background-color: #fff;
             border-radius: 5px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         .controls label {
             margin-right: 10px;
         }
    </style>
</head>
<body>

<h1>Web WorkerによるCanvas背景 (カラーマネジメント)</h1>

<canvas id="tilingCanvas"></canvas>

<div class="controls">
    <label for="colorSpaceSelect">カラースペース:</label>
    <select id="colorSpaceSelect">
        <option value="srgb" selected>sRGB (標準)</option>
        <option value="display-p3">Display P3 (広色域)</option>
        </select>
</div>

<div id="backgroundDiv">
    <h2>コンテンツエリア</h2>
    <p>このDIVの背景は、Web WorkerがCanvasに描画した内容です。</p>
    <p>カラースペースを変更すると、背景が再生成されます（対応ブラウザ/環境でのみ変化が見られます）。</p>
    </div>

<script>
    const canvas = document.getElementById('tilingCanvas');
    const backgroundDiv = document.getElementById('backgroundDiv');
    const colorSpaceSelect = document.getElementById('colorSpaceSelect');
    let worker = null; // Workerへの参照を保持

    // OffscreenCanvas と Worker のサポート確認
    const supportsOffscreen = typeof canvas?.transferControlToOffscreen === 'function';
    const supportsWorker = typeof window.Worker !== 'undefined';

    if (supportsOffscreen && supportsWorker) {
        try {
            // 1. OffscreenCanvas を作成
            const offscreen = canvas.transferControlToOffscreen();

            // 2. Web Worker を作成
            worker = new Worker('tiling.worker.js'); // Workerファイル名を指定

            // 3. Workerからのメッセージを受信
            worker.onmessage = (event) => {
                const data = event.data;
                if (data.type === 'dataUrl' && data.url) {
                    // Data URL を受け取ったらDIVの背景に設定
                    console.log("Main: Received Data URL from worker.");
                    if (backgroundDiv) {
                        backgroundDiv.style.backgroundImage = `url(${data.url})`;
                    }
                } else if (data.type === 'error') {
                    console.error("Main: Received error from worker:", data.message);
                    if (backgroundDiv) {
                         backgroundDiv.innerHTML = `<p style="color:red;">Worker Error: ${data.message}</p>`;
                    }
                }
                 else {
                     console.log("Main: Received message from worker:", data);
                }
            };

            // Workerでエラーが発生した場合
            worker.onerror = (error) => {
                console.error("Main: Error in Web Worker:", error.message, error);
                if (backgroundDiv) {
                    backgroundDiv.innerHTML = `<p style="color:red;">Worker Error: ${error.message}</p>`;
                }
            };

            // 4. OffscreenCanvas を Worker に転送
            worker.postMessage({ canvas: offscreen }, [offscreen]);
            console.log("Main: OffscreenCanvas transferred to worker.");

            // 5. 初期設定とイベントリスナー
            function initializeAndSendSettings() {
                // 初期サイズを送信
                sendResizeMessage();
                // 初期カラースペースを送信
                sendColorSpaceMessage();
            }

            function sendResizeMessage() {
                if (!worker) return;
                // Workerに実際の描画サイズを送信
                worker.postMessage({
                    type: 'resize',
                    width: window.innerWidth, // Workerにはフルサイズを渡す
                    height: window.innerHeight
                });
                console.log("Main: Resize message sent to worker.");
            }

            function sendColorSpaceMessage() {
                 if (!worker) return;
                 const selectedColorSpace = colorSpaceSelect.value;
                 worker.postMessage({
                     type: 'setColorSpace',
                     colorSpace: selectedColorSpace
                 });
                 console.log(`Main: Color space '${selectedColorSpace}' sent to worker.`);
            }

            // リサイズイベントリスナー (debounce)
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(sendResizeMessage, 150); // 少し長めに待つ
            });

            // カラースペース変更イベントリスナー
            colorSpaceSelect.addEventListener('change', sendColorSpaceMessage);

            // Workerの準備ができた可能性がある少し後に初期設定を送信
            setTimeout(initializeAndSendSettings, 100);


        } catch (e) {
             console.error("Main: Error initializing OffscreenCanvas or Worker:", e);
             if (backgroundDiv) {
                 backgroundDiv.innerHTML = `<p style="color:red;">Initialization Error: ${e.message}</p>`;
             }
        }

    } else {
        // OffscreenCanvas または Worker 非対応の場合
        let errorMsg = "";
        if (!supportsOffscreen) errorMsg += "OffscreenCanvasがサポートされていません。";
        if (!supportsWorker) errorMsg += (errorMsg ? " " : "") + "Web Workerがサポートされていません。";
        if (!canvas) errorMsg = "Canvas要素が見つかりません。";

        console.error("Main: Required features not supported.", {supportsOffscreen, supportsWorker});
        if (backgroundDiv) {
            backgroundDiv.innerHTML = `<p style='color:red;'>${errorMsg}</p>`;
        }
    }

</script>

</body>
</html>