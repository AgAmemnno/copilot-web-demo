<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSW Google Docs API Mock Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        h1, h2 { border-bottom: 1px solid #ccc; padding-bottom: 0.3em; }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; border-color: #ccc; cursor: not-allowed; }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        #loadingIndicator { display: none; margin-top: 10px; font-style: italic; }
    </style>
</head>
<body>

    <h1>MSW Google Docs API Mock Demo</h1>
    <p>
        このページは、MSW (Mock Service Worker) を使用してGoogle Docs APIの呼び出しをモックするデモです。<br>
        <strong>注意:</strong> このHTMLファイルと同じ階層に <code>npx msw init .</code> で生成された <code>mockServiceWorker.js</code> が必要です。また、HTTPサーバー経由でアクセスしてください。
    </p>

    <div>
        <button id="createDocButton">ドキュメント作成 (Mock)</button>
        <button id="getDocButton">ドキュメント取得 (Mock ID: mock_doc_123)</button>
        <button id="updateDocButton">ドキュメント更新 (Mock ID: mock_doc_123)</button>
        <button id="appendTextButton">テキスト追記 (to existing_doc_id_123)</button>
        <button id="applyHeadingStyleButton">先頭段落を見出し1に (existing_doc_id_123)</button>
        <button id="getErrorButton">存在しないドキュメント取得 (エラー発生)</button>
        <button id="bypassButton">バイパスされるリクエスト (例: /api/health)</button>
    </div>

    <div id="loadingIndicator">処理中...</div>

    <h2>APIレスポンス:</h2>
    <pre id="resultArea">ここにAPIレスポンスが表示されます...</pre>

    <h2>コンソールログ (MSW & App):</h2>
    <pre id="consoleLogArea">MSWのログやアプリのログはこちらに表示されます...</pre>


    <script type="module">
        import { http, HttpResponse ,delay} from 'https://cdn.jsdelivr.net/npm/msw@2.7.3/+esm';
        import { setupWorker } from 'https://cdn.jsdelivr.net/npm/msw@2.7.3/browser/+esm';
        import { googleDocsApiHandlers} from './handlers.js'; // モックハンドラを別ファイルに分けることも可能
        // --- ユーティリティ ---
        const resultArea = document.getElementById('resultArea');
        const consoleLogArea = document.getElementById('consoleLogArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const buttons = document.querySelectorAll('button');

        function logToScreen(area, message, type = 'info') {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.classList.add(type);
            area.appendChild(entry);
            area.scrollTop = area.scrollHeight; // 自動スクロール
        }

        function displayResult(data, error = false) {
            resultArea.textContent = JSON.stringify(data, null, 2);
            resultArea.className = error ? 'error' : 'success';
            logToScreen(consoleLogArea, `結果表示: ${error ? 'エラー' : '成功'}`, error ? 'error' : 'success');
        }

        function setLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
            buttons.forEach(btn => btn.disabled = isLoading);
        }



        const GOOGLE_DOCS_API_BASE_URL = 'https://docs.googleapis.com/v1';
        const worker = setupWorker(...googleDocsApiHandlers);
        async function makeApiCall(url, options = {}, buttonId) {
            logToScreen(consoleLogArea, `[App] API呼び出し開始: ${options.method || 'GET'} ${url}`);
            setLoading(true);
            resultArea.textContent = 'API呼び出し中...';
            resultArea.className = 'info';

            try {
                const response = await fetch(url, options);
                const responseText = await response.text(); // まずテキストとして取得
                let data;
                try {
                    data = JSON.parse(responseText); // JSONパースを試みる
                } catch (e) {
                    data = { rawResponse: responseText }; // パース失敗時は生のテキストを保持
                    if (!response.ok) { // レスポンスがOKでない場合は、テキストもエラー情報として扱う
                         throw { status: response.status, statusText: response.statusText, data: data };
                    }
                }


                logToScreen(consoleLogArea, `[App] APIレスポンス受信: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw { status: response.status, statusText: response.statusText, data: data };
                }
                displayResult(data);
            } catch (error) {
                logToScreen(consoleLogArea, `[App] API呼び出しエラー: ${error.statusText || error.message}`, 'error');
                displayResult(error.data || { message: error.message, status: error.status, statusText: error.statusText }, true);
            } finally {
                setLoading(false);
            }
        }

        document.getElementById('createDocButton').addEventListener('click', () => {
            makeApiCall(`${GOOGLE_DOCS_API_BASE_URL}/documents`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: 'My Awesome Document' })
            }, 'createDocButton');
        });

        document.getElementById('getDocButton').addEventListener('click', () => {
            makeApiCall(`${GOOGLE_DOCS_API_BASE_URL}/documents/mock_doc_123`, {}, 'getDocButton');
        });

        document.getElementById('updateDocButton').addEventListener('click', () => {
            makeApiCall(`${GOOGLE_DOCS_API_BASE_URL}/documents/mock_doc_123:batchUpdate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    requests: [
                        { insertText: { location: { index: 1 }, text: "追加テキスト！\n" } },
                        { updateDocumentStyle: { fields: "pageSize", documentStyle: { pageSize: { width: { magnitude: 500, unit: "PT" } }}}}
                    ]
                })
            }, 'updateDocButton');
        });

        document.getElementById('getErrorButton').addEventListener('click', () => {
            makeApiCall(`${GOOGLE_DOCS_API_BASE_URL}/documents/non_existent_document_id`, {}, 'getErrorButton');
        });

        document.getElementById('bypassButton').addEventListener('click', () => {
            // このエンドポイントはMSWハンドラに定義されていないため、
            // worker.startのonUnhandledRequest設定に従って処理される。
            // 'bypass'なら実際のネットワークへ (この場合、存在しないのでネットワークエラーになる)
            // 'warn'ならコンソールに警告
            // 'error'ならMSWがエラーを返す
            logToScreen(consoleLogArea, "[App] バイパスされるリクエスト /api/health を試みます。");
            makeApiCall('/api/health', {}, 'bypassButton');
        });

        // index.html の <script type="module"> 内
        
        // --- 既存の GOOGLE_DOCS_API_BASE_URL, makeApiCall, logToScreen, displayResult, setLoading などは定義済みとする ---
        
        // === 新しいユーティリティ関数 (簡易版) ===

        /**
         * (簡易版) ドキュメントにテキストを追記する
         * @param {string} documentId
         * @param {string} textToAppend
         */
         async function appendTextToDocument(documentId, textToAppend) {
            logToScreen(consoleLogArea, `[App] appendTextToDocument呼び出し: docId=${documentId}`);
            const requests = [
                {
                    insertText: {
                        // ドキュメントの末尾に挿入 (セグメントIDなしはメインボディの末尾)
                        endOfSegmentLocation: {
                            segmentId: ''
                        },
                        text: textToAppend
                    }
                }
            ];
            // 共通のAPI呼び出し関数 makeApiCall を使用
            return makeApiCall(
                `${GOOGLE_DOCS_API_BASE_URL}/documents/${documentId}:batchUpdate`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requests: requests })
                },
                'appendTextButton' // ログや状態管理のためのボタンID（任意）
            );
        }

        /**
         * (簡易版) 指定範囲の段落スタイルを変更する
         * @param {string} documentId
         * @param {{startIndex: number, endIndex: number}} range - スタイルを適用する範囲
         * @param {{namedStyleType: string}} paragraphStyle - 例: { namedStyleType: 'HEADING_1' }
         */
        async function applyParagraphStyleToDoc(documentId, range, paragraphStyle) {
            logToScreen(consoleLogArea, `[App] applyParagraphStyleToDoc呼び出し: docId=${documentId}`);
            const requests = [
                {
                    updateParagraphStyle: {
                        range: range,
                        paragraphStyle: paragraphStyle,
                        fields: 'namedStyleType' // 変更するフィールドを指定 (ここではnamedStyleTypeのみ)
                    }
                }
            ];
            return makeApiCall(
                `${GOOGLE_DOCS_API_BASE_URL}/documents/${documentId}:batchUpdate`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requests: requests })
                },
                'applyHeadingStyleButton' // ログや状態管理のためのボタンID（任意）
            );
        }


        // === 新しいボタンのイベントリスナー ===
        document.getElementById('appendTextButton').addEventListener('click', async () => {
            const docId = "mock_doc_123"; // MSWのmockDocumentStoreに存在するID
            const text = "これは追記されたテキストです。\n次の行です。\n";
            logToScreen(consoleLogArea, `[User Action] テキスト追記ボタンクリック (ID: ${docId})`);
            await appendTextToDocument(docId, text);
        });
        document.getElementById('applyHeadingStyleButton').addEventListener('click', async () => {
            const docId = "mock_doc_123"; // MSWのmockDocumentStoreに存在するID
            // 注: 実際のドキュメントの先頭段落の範囲は動的に取得する必要があります。
            // ここでは、1文字目から20文字目までを対象とする例とします（適宜調整してください）。
            // mockDocumentStoreの existing_doc_id_123 の初期コンテンツは改行のみなので、
            // appendTextButton でテキストを追記した後にこのボタンを押すと効果が分かりやすいです。
            // もし何もテキストがない状態なら、startIndex:1, endIndex:1 で段落全体を指すのが良いかもしれません。
            const range = { startIndex: 1, endIndex: 2 }; // 例: 最初の段落を指す (非常に短い範囲だが段落スタイルはこれでOK)
            const style = { namedStyleType: 'HEADING_1' };
            logToScreen(consoleLogArea, `[User Action] 先頭段落を見出し1にボタンクリック (ID: ${docId})`);
            await applyParagraphStyleToDoc(docId, range, style);
        });

        // ... (既存のMSWワーカー起動処理 `startMSW()` など) ...
        async function startMSW() {
            logToScreen(consoleLogArea, "MSWワーカーの起動を試みます...");
            try {
                await worker.start({
                    // ↓↓↓ この serviceWorker.url オプションを追加・確認してください ↓↓↓
                    serviceWorker: {
                        url: '/mock_API2/mockServiceWorker.js' // Viteのdevサーバーのルートからの絶対パス
                    },
                    onUnhandledRequest: (req, print) => {
                        print.warning();
                        logToScreen(consoleLogArea, `[MSW] 未処理のリクエスト: ${req.method} ${req.url.href}`, 'warn');
                    },
                    quiet: false,
                });
                logToScreen(consoleLogArea, "MSWワーカーが正常に起動しました。", "success");
                resultArea.textContent = 'MSWが起動しました。ボタンを押してAPIを呼び出してください。';
                resultArea.className = 'info';
            } catch (error) {
                logToScreen(consoleLogArea, `MSWワーカーの起動に失敗しました: ${error}`, 'error');
                resultArea.textContent = `MSWワーカーの起動に失敗しました: ${error}`;
                resultArea.className = 'error';
            }
        }
        startMSW();

    </script>
</body>
</html>